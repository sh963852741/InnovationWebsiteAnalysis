<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <noscript>Your browser does not support JavaScript!</noscript>
    <link href="css/bootstrap.css" rel="stylesheet" />
    <script src="js/jquery-3.5.1.js" type="text/javascript"></script>
    <script src="js/bootstrap.bundle.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/dist/echarts.js"></script>
    <title>大创项目分析图</title>
</head>

<body>
    <div class="jumbotron jumbotron-fluid">
        <div class="container">
            <h1 class="display-4">信息学院大创项目分析图</h1>
            <p class="lead" style="display: none;">这是一个十分庞大的项目，有概览图、详细图什么的。</p>
        </div>
    </div>
    <!--概览图-->
    <div class="container-xl">
        <div id="main-chart" style="width: 100%; height:600px;"></div>
    </div>
    <hr />
    <!--详细图-->
    <div class="container-xl">
        <div class="row">
            <div class="col-6">
                <div class="row">
                    <div id="detail-chart-1" style="width: 100%; height: 45vh;"></div>
                </div>
                <div class="row">
                    <div id="detail-chart-2" style="width: 100%; height: 45vh;">
                        <em>此处空白</em>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div id="detail-chart-3" style=" height: 90vh;"></div>
            </div>
        </div>
    </div>
    <script src="http://cxw.xmu.edu.cn/api/datacenter/GetDataSource?depart=信息学院&type=js"></script>
    <script type="text/javascript">
        loadMainChart();
        loadDetailChart();
        function processBatchDimension(sourceData) {
            let xAxisData = sourceData.map(e => `${e.ApplyYear}(${e.Batch})`);
            let establishedData = sourceData.map(e => e.通过项目数);
            let concludedData = sourceData.map(e => e.项目结题数);
            let studentCount = sourceData.map(e => e.通过项目的参与学生数);
            return {
                xAxisData,
                establishedData,
                concludedData,
                studentCount
            }
        }
        function processMajorDimension(sourceData) {
            let data = [];
            for (item of sourceData) {
                let majorData = data.find(e => e.name === item.Major);
                if (majorData) {
                    let gradeData = majorData.children.find(e => e.name === item.Grade);
                    if (gradeData) {
                        ++gradeData.value;
                    } else {
                        majorData.children.push({
                            name: item.Grade,
                            value: 1
                        })
                    }
                } else {
                    data.push({
                        name: item.Major,
                        children: [{
                            name: item.Grade,
                            value: 1
                        }]
                    })
                }
            }
            return data;
        }
        function processTeacherDimension(sourceData) {
            let yAxisData = sourceData.map(e => e.GuideTeacher);
            let establishedData = sourceData.map(e => e.指导项目数);
            let concludedData = sourceData.map(e => e.项目结题数);
            return {
                yAxisData,
                establishedData,
                concludedData
            }
        }
        function loadMainChart() {
            let mainChart = echarts.init(document.getElementById('main-chart'));
            let data = processBatchDimension(dataSource.BatchDimension);
            let option = {
                title: {
                    text: '总览'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {}
                    }
                },
                legend: {
                    data: ['已立项', '已结题', '参与学生数']
                },
                xAxis: {
                    type: 'category',
                    data: data.xAxisData,
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: '学生数',
                        axisLabel: {
                            formatter: '{value} 人'
                        }
                    },
                    {
                        type: 'value',
                        name: '项目数',
                        axisLabel: {
                            formatter: '{value} 项'
                        }
                    }
                ],
                series: [{
                    name: '已立项',
                    type: 'bar',
                    data: data.establishedData
                },
                {
                    name: '已结题',
                    type: 'bar',
                    data: data.concludedData
                },
                {
                    name: '参与学生数',
                    type: 'line',
                    yAxisIndex: 1,
                    data: data.studentCount
                }]
            };
            mainChart.setOption(option);
        }
        function loadDetailChart(batchNumber) {
            let detailChart1 = echarts.init(document.getElementById('detail-chart-1'));
            let majorData = processMajorDimension(dataSource.MajorDimension);
            let option1 = {
                series: {
                    type: 'sunburst',
                    data: majorData
                }
            }
            detailChart1.setOption(option1);

            let detailChart3 = echarts.init(document.getElementById('detail-chart-3'));
            let teacherData = processTeacherDimension(dataSource.GuideTeacherDimension);
            let option3 = {
                title: {
                    text: '学院老师指导大创项目数'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['已立项', '已结题']
                },
                xAxis: {
                    type: 'value'
                },
                yAxis: {
                    type: 'category',
                    data: teacherData.yAxisData
                },
                series: [
                    {
                        name: '已立项',
                        type: 'bar',
                        data: teacherData.establishedData
                    },
                    {
                        name: '已结题',
                        type: 'bar',
                        data: teacherData.concludedData
                    }
                ]
            }
            detailChart3.setOption(option3);
        }
    </script>
</body>

</html>